# 网站性能优化

>《高性能网站建设指南》笔记

性能黄金法则:

只有10%-20%的最终用户响应时间花在了下载HTML文档上。其余的80%～90%时间花在了下载页面中的所有组件上。

## 1. 减少HTTP请求
1. 图片地图
2. CSS Sprites
3. 内联图片
4. 合并脚本和样式表

## 2. 使用内容发布网络
1. CDN用户发布静态内容。因这些内容容易储存，并具有较少的依赖性。
2. 动态的HTML并不适合做CND。会引来管理的难题。

## 3. 添加Expires头
Cache-Control: max-age=60000

HTML设置不缓存。
为图片、样式表、脚本等设置缓存。
当需要更新时，改变所有组件文件名中的变量，以获取最新代码。
例如：webpack的hash功能。

## 4. 压缩组件
Http1.1开始，Web客户端可以通过HTTP请求中的Accept-Encoding头来表示对压缩的支持。
```
Accept-Encoding: gzipm deflate
```

压缩成本:
  - 服务器会消耗CPU

压缩优势:
  - 通常能将响应的数据量减少近70%

1. 压缩的对象
  - HTML
  - 脚本
  - 样式表
>图片和PDF不应该被压缩，因为它们本来就已经压缩了。压缩反而有可能增加文件大小。

Apache 配置:
  - 配置压缩的文件类型
  - 配置压缩内容的缓存，以减少服务器压力。

代理缓存的配置:
  - 添加`Vary: Accept-Encoding`

代理将会为Accept-Encoding请求头的每个值缓存一份。

当设置Apache `mod_gzip`或`mod_deflate`时，`Very`会默认添加。

## 5. 将样式表放在顶部

可视化回馈。
- 告诉用户系统没有崩溃
- 指示出用户大概需要等多久
- 给用户一点可以看的东西，使得等待不那么无聊

规则:
- link放在HEAD中
- 不用@import 因为其加载顺序不确定，可能会最后加载。

优点:
- 避免白屏
- 无样式内容闪烁（先渲染了内容，然后样式表才渲染，导致布局变化）

## 6. 将脚本放在底部

HTTP1.1建议从每个主机名并行的下载两个组件。

脚本阻塞下载。下载脚本时并行下载是被禁用的。脚本会阻塞对其后面内容的呈现。脚本会阻塞对其后面组件的下载。

规则
- 使用两个主机名, 加快下载速度。
- 将脚本放到页面底部。

## 7. 避免CSS表达式

规则
- 避免使用CSS表达式
  - 使用一次行表达式
- 使用事件处理器提供动态行为。

## 8. 使用外部JavaScript和CSS

纯粹而言，内联快一些

但是：
  - JavaScript和CSS文件有机会被浏览器缓存起来
  - HTML通常不会配置为可以进行缓存
  - 页面浏览量越大-外部文件带来的收益越大
  - 组件重用(在组件，重用的组件可以做成单独的js和CSS以增加缓存)

**其他方案：**
  - 加载后下载 <br>
    在文件onload后，动态下载后续组件的js和css。
    要避免脚本文件执行，影响当前页面。
    使用两次的css如果指定两次可能会产生问题。
    将这些组件放在一个看不到iframe中更好。
  - 动态内联 <br>
    通过cookie判断是否缓存了外部组件，缓存了就采用外部组件的形式。否则就采用内联的方式。

特殊情况：

**主页**

主页的重用率很低，为了更快的加载，主页可以内联。

## 9. 减少DNS查找
DNC(Domain Name System)

DNS查询过程:
  - 用户计算机
    - 浏览器DNS
    - DNS客户端服务
  - 广域域名体系
    - DNS解析器

其中有一个有缓存，就会从缓存进行解析。

私用Keep-Alive和较少的域名来减少DNS查找
  - 一般情况下一个持久的TCP连接会一直用，直到其空闲一分钟为止。
  - Keep-Alive的连接是持久的，因此无需DNS查找
  - Keep-Alive可以通过重用现有连接避免DNS查找

## 10. 精简JavaScript

规则:
  - 精简(移除注释、空格、换行、制表符等)
  - 混淆(改写代码)

## 11. 避免重定向

规则
  - 重定向会延迟页面的响应。
  - 缺少结尾斜线<br>
    - URL结尾必须出现`/`而没有出现时。
    - 缺少斜线时，浏览器会允许自动索引，自动赚到默认的index.html上。
    - 主机名后缺少`/`不会重定向。

重定向的使用
  - 连接网站
  - 跟踪内部流量
  - 跟踪出站流量

## 12. 删除重复脚本
规则:
  - 确保脚本只被包含一次

影响:
  - 使页面变慢
  - 产生额外的HTTP请求
  - 脚本会多次被执行

## 13. 配置ETag

ETag (Entity tag)实体标签，是Web服务器和浏览器确认缓存组件有效性的一种机制。

服务器检测缓存组件有效性2种方式:
  - 比较最新修改日期(Last-Modified)
  - 比较实体标签(ETag)

如果组件是有效的，返回`304 Not Modified` 状态码

即使组件有长久的Expires头， 一旦用户点击了Reload或Refresh按钮，仍会产生条件get请求。

**ETag问题:**

对于多个服务器的网站，由于默认情况下不同服务器的Apache和IIS产生的ETag是不同的，会降低有效性验证的成功率。

解决办法:
  - Apache 1.3.23及之后的版本支持FileETag指令，可以从ETag指令中移除inode值
  - IIS可以为所有的服务器设置相同的ChangeNumber， 保留文件的时间戳作为ETag中仅有的另一块信息。

## 14. 使Ajax可缓存

get有肯能被缓存

post不会被缓存

适用规则:
  - 规则3-添加Expires头
  - 规则4-压缩组件
  - 规则9-减少DNS查找
  - 规则10-精简JavaScript
  - 规则11-避免重定向
  - 规则13-ETag

get请求可以通过参数进行缓存，当需要更新时，改变参数值。
